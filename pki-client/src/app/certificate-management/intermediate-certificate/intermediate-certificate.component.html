<app-navbar></app-navbar>
<div class="container mt-4">
  <h2>Kreiranje Intermediate Sertifikata</h2>
  <p>Popunite podatke da biste generisali novi Intermediate sertifikat.</p>
  <hr>

  <!-- Prikazujemo poruku o učitavanju dok se ne dobiju podaci sa servera -->
  <div *ngIf="isLoading; else formContent" class="loading-container">
    <p>Učitavanje podataka...</p>
    <!-- Ovde se može dodati i neki animirani spinner za bolji UX -->
  </div>

  <!-- Kada se podaci učitaju, prikazujemo formu -->
  <ng-template #formContent>
    <form [formGroup]="intermediateCertForm" (ngSubmit)="onSubmit()">

      <div class="form-group mb-3">
        <label for="templateId" class="form-label">Koristi Šablon (Opciono)</label>
        <select id="templateId" class="form-control" formControlName="templateId">
          <option [ngValue]="null">-- Bez Šablona --</option>
          <option *ngFor="let template of templates" [value]="template.id">
            {{ template.name }}
          </option>
        </select>
      </div>

      <!-- Dropdown za izbor Izdavaoca (Issuer) -->
      <div class="form-group mb-3">
        <label for="issuerSerialNumber" class="form-label">Izdavalac (Potpisnik)</label>
        <select id="issuerSerialNumber" class="form-control" formControlName="issuerSerialNumber">
          <option [ngValue]="null" disabled>Izaberite sertifikat kojim se potpisuje...</option>
          <option *ngFor="let issuer of issuers" [value]="issuer.serialNumber">
            {{ issuer.commonName }} (SN: {{ issuer.serialNumber }})
          </option>
        </select>
        <div *ngIf="isControlInvalid('issuerSerialNumber')" class="text-danger mt-1">
          Morate izabrati izdavaoca sertifikata.
        </div>
      </div>

      <!-- Polja za novi sertifikat -->
      <div class="form-group mb-3">
        <label for="commonName" class="form-label">Common Name (CN)</label>
        <input type="text" id="commonName" class="form-control" formControlName="commonName" placeholder="Npr. Moja Kompanija Intermediate CA">
        <!-- Prikazujemo i grešku za regex ako je šablon izabran -->
        <div *ngIf="isControlInvalid('commonName')" class="text-danger mt-1">
          <div *ngIf="intermediateCertForm.get('commonName')?.errors?.['required']">Common Name je obavezno polje.</div>
          <div *ngIf="intermediateCertForm.get('commonName')?.errors?.['pattern']">Format ne odgovara pravilima šablona.</div>
        </div>
      </div>
      
      <!-- Polje za Organizaciju - biće zaključano ako je šablon izabran -->
      <div class="form-group mb-3">
        <label for="organization" class="form-label">Organizacija (O)</label>
        <input type="text" id="organization" class="form-control" formControlName="organization" placeholder="Npr. Moja Kompanija">
        <div *ngIf="isControlInvalid('organization')" class="text-danger mt-1">Naziv organizacije je obavezno polje.</div>
      </div>

      <div class="form-group mb-3">
        <label for="organizationalUnit" class="form-label">Organizaciona Jedinica (OU)</label>
        <input type="text" id="organizationalUnit" class="form-control" formControlName="organizationalUnit" placeholder="Npr. IT Sektor">
        <div *ngIf="isControlInvalid('organizationalUnit')" class="text-danger mt-1">Organizaciona jedinica je obavezno polje.</div>
      </div>

      <div class="form-group mb-3">
        <label for="country" class="form-label">Kod Države (C)</label>
        <input type="text" id="country" class="form-control" formControlName="country" placeholder="Npr. RS">
        <div *ngIf="isControlInvalid('country')" class="text-danger mt-1">
          <div *ngIf="intermediateCertForm.get('country')?.errors?.['required']">Kod države je obavezno polje.</div>
          <div *ngIf="intermediateCertForm.get('country')?.errors?.['pattern']">Unesite tačno 2 velika slova.</div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="email" class="form-label">Email Adresa</label>
        <input type="email" id="email" class="form-control" formControlName="email" placeholder="kontakt@mojakompanija.com">
        <div *ngIf="isControlInvalid('email')" class="text-danger mt-1">
          <div *ngIf="intermediateCertForm.get('email')?.errors?.['required']">Email je obavezno polje.</div>
          <div *ngIf="intermediateCertForm.get('email')?.errors?.['email']">Unesite validnu email adresu.</div>
        </div>
      </div>

      <!-- Polja za datume -->
      <div class="form-group mb-3">
        <label for="validFrom" class="form-label">Datum Početka Važenja</label>
        <input type="datetime-local" id="validFrom" class="form-control" formControlName="validFrom">
        <div *ngIf="isControlInvalid('validFrom')" class="text-danger mt-1">
          <div *ngIf="intermediateCertForm.get('validFrom')?.errors?.['required']">Datum početka je obavezno polje.</div>
          <div *ngIf="intermediateCertForm.get('validFrom')?.errors?.['dateInPast']">Datum ne može biti u prošlosti.</div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="validTo" class="form-label">Datum Isteka Važenja</label>
        <input type="datetime-local" id="validTo" class="form-control" formControlName="validTo">
        <div *ngIf="isControlInvalid('validTo')" class="text-danger mt-1">
          <div *ngIf="intermediateCertForm.get('validTo')?.errors?.['required']">Datum isteka je obavezno polje.</div>
          <div *ngIf="intermediateCertForm.get('validTo')?.errors?.['dateInPast']">Datum isteka ne može biti u prošlosti.</div>
          <div *ngIf="intermediateCertForm.get('validTo')?.errors?.['dateRangeInvalid']">Datum isteka mora biti nakon datuma početka.</div>
        </div>
      </div>

      <!-- Dropdown za izbor Vlasnika (Owner) - SAMO ZA ADMINA -->
      <div *ngIf="isAdmin" class="form-group mb-3">
        <label for="ownerId" class="form-label">Dodeli vlasništvo (samo za Admina)</label>
        <select id="ownerId" class="form-control" formControlName="ownerId">
          <option [ngValue]="null" disabled>Izaberite CA korisnika...</option>
          <option *ngFor="let user of users" [value]="user.id">
            {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
          </option>
        </select>
        <div *ngIf="isControlInvalid('ownerId')" class="text-danger mt-1">
          Morate izabrati korisnika kome se dodeljuje sertifikat.
        </div>
      </div>

      <div *ngIf="isTemplateSelected">
        <hr>
        <p class="form-section-title">Ekstenzije definisane šablonom</p>
        
        <!-- Key Usage -->
        <div class="form-group mb-3" formArrayName="keyUsage">
          <label class="form-label">Key Usage</label>
          <div class="checkbox-group-readonly">
            <div *ngFor="let option of keyUsageOptions; let i = index" 
                class="checkbox-item" [class.selected]="keyUsageControls[i].value">
              <input type="checkbox" [formControlName]="i" style="display: none;"> 
              <mat-icon>{{ keyUsageControls[i].value ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
              <span>{{ option.name }}</span>
            </div>
          </div>
        </div>

        <!-- Extended Key Usage -->
        <div class="form-group mb-3" formArrayName="extendedKeyUsage">
          <label class="form-label">Extended Key Usage</label>
          <div class="checkbox-group-readonly">
            <div *ngFor="let option of extendedKeyUsageOptions; let i = index"
                class="checkbox-item" [class.selected]="extendedKeyUsageControls[i].value">
              <input type="checkbox" [formControlName]="i" style="display: none;"> 
              <mat-icon>{{ extendedKeyUsageControls[i].value ? 'check_box' : 'check_box_outline_blank' }}</mat-icon>
              <span>{{ option.name }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dugme za slanje -->
      <button type="submit" class="btn btn-primary" [disabled]="intermediateCertForm.invalid">Kreiraj Intermediate Sertifikat</button>
    </form>
  </ng-template>
</div>